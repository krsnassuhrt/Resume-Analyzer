<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Resume Relevance Check</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-8">
        <header class="text-center mb-10 flex items-center justify-center gap-4">
            <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <div>
                <h1 class="text-4xl font-bold text-gray-800">Automated Resume Relevance Check</h1>
                <p class="text-gray-600">The intelligent tool for modern recruitment.</p>
            </div>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
            <div class="bg-white p-6 rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-300">
                <h2 class="text-2xl font-semibold mb-4">Upload Files</h2>
                <div class="mb-4">
                    <label for="resume" class="block text-gray-700 font-medium mb-2">Upload Resume (.pdf, .docx)</label>
                    <input type="file" id="resume" accept=".pdf,.docx" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="job_description" class="block text-gray-700 font-medium mb-2">Upload Job Description (.pdf, .docx)</label>
                    <input type="file" id="job_description" accept=".pdf,.docx" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <button id="analyzeBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Analyze</button>
            </div>
            <div id="results-container" class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Analysis Results</h2>
                <div id="results" class="text-gray-700">
                    <p>Analysis results will appear here. Click 'View Details' on an item in the history to review it.</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h2 class="text-2xl font-semibold">Evaluation History</h2>
                <div class="flex items-center space-x-4">
                    <input type="text" id="searchInput" placeholder="Search by filename..." class="p-2 border border-gray-300 rounded-lg">
                    <select id="verdictFilter" class="p-2 border border-gray-300 rounded-lg">
                        <option value="">All Verdicts</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <button id="clearHistoryBtn" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">Clear History</button>
                </div>
            </div>
            <div id="history-table-container" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resume</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Desc.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Verdict</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Analysis Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="history-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const resultsDiv = document.getElementById('results');
        const historyBody = document.getElementById('history-body');
        const searchInput = document.getElementById('searchInput');
        const verdictFilter = document.getElementById('verdictFilter');
        let evaluationHistoryCache = [];

        async function fetchHistory() {
            const searchTerm = searchInput.value;
            const verdict = verdictFilter.value;
            const url = `http://127.0.0.1:5000/evaluations?search=${encodeURIComponent(searchTerm)}&verdict=${encodeURIComponent(verdict)}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load history');
                evaluationHistoryCache = await response.json();
                renderHistoryTable();
            } catch (error) {
                console.error("Failed to fetch history:", error);
                historyBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Could not connect to the server.</td></tr>';
            }
        }

        function renderHistoryTable() {
            historyBody.innerHTML = '';
            if (evaluationHistoryCache.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No matching records found.</td></tr>';
                return;
            }
            evaluationHistoryCache.forEach((item, index) => {
                let verdictColor = 'text-gray-500';
                if (item.verdict === 'High') verdictColor = 'text-green-500';
                else if (item.verdict === 'Medium') verdictColor = 'text-yellow-600';
                else if (item.verdict === 'Low') verdictColor = 'text-red-500';

                // FIX for the "undefined" bug
                const analysisType = item.analysis_type || 'Local';
                let analysisTypeColor = analysisType === 'Hybrid (Local + AI)' ? 'text-green-600' : 'text-orange-500';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${item.resume_filename}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${item.jd_filename}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-bold ${verdictColor}">${item.relevance_score}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-semibold ${verdictColor}">${item.verdict}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${analysisTypeColor}">${analysisType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button class="text-blue-600 hover:underline" onclick="showDetails(${index})">View Details</button>
                    </td>
                `;
                historyBody.appendChild(row);
            });
        }
        
        // NEW function to show details in the main panel
        function showDetails(index) {
            const data = evaluationHistoryCache[index];
            if (!data) return;

            let verdictColor = 'text-gray-700';
            if (data.verdict === 'High') verdictColor = 'text-green-600';
            else if (data.verdict === 'Medium') verdictColor = 'text-yellow-600';
            else if (data.verdict === 'Low') verdictColor = 'text-red-600';
            
            const analysisType = data.analysis_type || 'Local';
            let analysisTypeColor = analysisType === 'Hybrid (Local + AI)' ? 'text-green-600' : 'text-orange-500';
            
            // Ensure skills are parsed safely
            const matchedSkills = JSON.parse(data.matched_skills || '[]');
            const missingSkills = JSON.parse(data.missing_skills || '[]');

            resultsDiv.innerHTML = `
                <div class="space-y-3">
                    <div><h4 class="font-semibold text-lg">Relevance Score: <span class="font-bold ${verdictColor}">${data.relevance_score}</span></h4></div>
                    <div><h4 class="font-semibold text-lg">Verdict: <span class="font-semibold ${verdictColor}">${data.verdict}</span></h4></div>
                    <div><h4 class="font-semibold text-lg">Analysis Type: <span class="font-medium ${analysisTypeColor}">${analysisType}</span></h4></div>
                    <hr>
                    <div><h4 class="font-semibold">Feedback:</h4><p class="text-sm">${data.feedback}</p></div>
                    <div><h4 class="font-semibold">Matched Skills (${matchedSkills.length}):</h4><p class="text-sm text-green-700">${matchedSkills.join(', ') || 'None'}</p></div>
                    <div><h4 class="font-semibold">Missing Skills (${missingSkills.length}):</h4><p class="text-sm text-red-700">${missingSkills.join(', ') || 'None'}</p></div>
                </div>
            `;
        }

        analyzeBtn.addEventListener('click', async () => {
            const resumeInput = document.getElementById('resume');
            const jdInput = document.getElementById('job_description');
            if (!resumeInput.files[0] || !jdInput.files[0]) {
                resultsDiv.innerHTML = '<p class="text-red-500 font-semibold">Please upload both files.</p>';
                return;
            }
            resultsDiv.innerHTML = '<div class="loader"></div><p class="text-center text-blue-500">Performing analysis...</p>';
            analyzeBtn.disabled = true;
            analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            const formData = new FormData();
            formData.append('resume', resumeInput.files[0]);
            formData.append('job_description', jdInput.files[0]);
            
            try {
                const response = await fetch('http://127.0.0.1:5000/analyze', { method: 'POST', body: formData });
                const data = await response.json();
                
                if (response.ok) {
                    await fetchHistory(); // Update history in the background
                    // Now show the new analysis details in the main panel
                    showDetails(0); // The new item is always at the top of the history
                } else {
                    resultsDiv.innerHTML = `<p class="text-red-500"><b>Error:</b> ${data.error || 'An unknown error occurred.'}</p>`;
                }
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = '<p class="text-red-500"><b>Error:</b> Could not connect to the backend.</p>';
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
        
        clearHistoryBtn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to clear the entire evaluation history? This action cannot be undone.')) return;
            try {
                const response = await fetch('http://127.0.0.1:5000/evaluations/delete', { method: 'POST' });
                if (response.ok) { 
                    fetchHistory(); 
                    resultsDiv.innerHTML = '<p>Analysis results will appear here. Click \'View Details\' on an item in the history to review it.</p>';
                } else { 
                    alert('Failed to clear history.'); 
                }
            } catch (error) {
                console.error('Error clearing history:', error);
                alert('Could not connect to the backend to clear history.');
            }
        });

        searchInput.addEventListener('input', fetchHistory);
        verdictFilter.addEventListener('change', fetchHistory);
        document.addEventListener('DOMContentLoaded', fetchHistory);
    </script>
</body>
</html>

